<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MooneyMaker ‚Ä¢ Alertas de Seguridad</title>
  <link rel="stylesheet" href="styles.css"/>
</head>

<body>
  <div class="app-nosidebar">

    <!-- TOPBAR -->
<header class="topbar">
  <div class="topbar-inner">

    <!-- Marca -->
    <div class="topbar-left">
      <span class="brand">MooneyMaker</span>
    </div>

    <!-- Bot√≥n hamburguesa (solo mobile) -->
    <button class="hamburger" id="hamburgerBtn" aria-label="Abrir men√∫" aria-expanded="false">
      <span></span>
    </button>

    <!-- Navegaci√≥n desktop -->
    <nav class="topbar-center nav-desktop">
      <a href="egreso.html" class="nav-item">Retiros</a>
      <a href="consulta-egresos.html" class="nav-item">Historial</a>
      <a href="usuarios.html" class="nav-item" data-admin-only="1">Usuarios</a>
      <a href="logs.html" class="nav-item" data-admin-only="1">Logs</a>
      <a href="alertas.html" class="nav-item active" data-admin-only="1">
        Alertas
        <span id="alertBadge" class="alert-badge-nav" style="display:none;"></span>
      </a>
    </nav>

    <!-- Acciones desktop -->
    <div class="topbar-right nav-desktop">
      <span id="whoami" class="user-badge">‚Äî</span>
      <button id="logoutBtn" class="btn-logout">Salir</button>
    </div>
  </div>

  <!-- Men√∫ mobile (drawer) -->
  <div class="mobile-drawer" id="mobileDrawer" aria-hidden="true">
    <div class="mobile-drawer-head">
      <span class="brand">MooneyMaker</span>
      <button class="drawer-close" id="closeDrawerBtn" aria-label="Cerrar men√∫">‚úï</button>
    </div>

    <nav class="mobile-nav">
      <a href="egreso.html" class="mobile-item">Retiros</a>
      <a href="consulta-egresos.html" class="mobile-item">Historial</a>
      <a href="usuarios.html" class="mobile-item" data-admin-only="1">Usuarios</a>
      <a href="logs.html" class="mobile-item" data-admin-only="1">Logs</a>
      <a href="alertas.html" class="mobile-item active" data-admin-only="1">
        Alertas
        <span id="alertBadgeMobile" class="alert-badge-nav" style="display:none;"></span>
      </a>
    </nav>

    <div class="mobile-actions">
      <div id="whoamiMobile" class="user-badge">‚Äî</div>
      <button id="logoutBtnMobile" class="btn-logout">Salir</button>
    </div>
  </div>

  <!-- overlay -->
  <div class="drawer-overlay" id="drawerOverlay"></div>
</header>

    <!-- CONTENT -->
    <main class="content-wrap">
      <div class="page">

        <!-- Card principal -->
        <section class="card">
          <div class="card-header">üö® Alertas de Seguridad</div>
          <div class="card-body">

            <!-- Estad√≠sticas -->
            <div class="section span12">
              <div class="section-head">
                <div class="section-title">üìä Estad√≠sticas</div>
                <div class="section-subtitle">Resumen de alertas del sistema</div>
              </div>

              <div class="section-body" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;" id="statsGrid">
                <!-- Se carga din√°micamente -->
              </div>
            </div>

            <!-- Filtros -->
            <div class="section span12" style="margin-top:24px">
              <div class="section-head">
                <div class="section-title">üîç Filtros</div>
                <div class="section-subtitle">Filtrar alertas por estado y severidad</div>
              </div>

              <div class="section-body grid">
                <div class="field span6">
                  <label>ESTADO</label>
                  <select id="filterStatus">
                    <option value="all">Todas</option>
                    <option value="pending" selected>Pendientes</option>
                    <option value="acknowledged">Vistas</option>
                    <option value="resolved">Resueltas</option>
                  </select>
                </div>

                <div class="field span6">
                  <label>SEVERIDAD</label>
                  <select id="filterSeverity">
                    <option value="all">Todas</option>
                    <option value="critical">Cr√≠ticas</option>
                    <option value="high">Altas</option>
                    <option value="medium">Medias</option>
                    <option value="low">Bajas</option>
                  </select>
                </div>

                <div class="actions span12">
                  <button id="btnFilter" class="btn btn-primary" type="button">Aplicar filtros</button>
                  <button id="btnRefresh" class="btn btn-ghost" type="button">Actualizar</button>
                </div>
              </div>
            </div>

            <!-- Lista de alertas -->
            <div class="section span12" style="margin-top:24px">
              <div class="section-head">
                <div class="section-title">üìã Alertas</div>
                <div class="section-subtitle" id="alertCount">‚Äî</div>
              </div>

              <div class="section-body">
                <div class="table-wrap">
                  <table class="table" id="alertsTable">
                    <thead>
                      <tr>
                        <th>Severidad</th>
                        <th>Tipo</th>
                        <th>Mensaje</th>
                        <th>Usuario</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="alertsTbody">
                      <tr><td colspan="7" class="muted">Cargando alertas‚Ä¶</td></tr>
                    </tbody>
                  </table>
                </div>

                <!-- Empty state -->
                <div id="emptyState" style="display:none; text-align:center; padding:40px; color:var(--muted);">
                  <div style="font-size:48px; margin-bottom:12px;">‚úÖ</div>
                  <div style="font-size:16px; font-weight:700;">No hay alertas</div>
                  <div style="font-size:13px; margin-top:4px;">Todo est√° funcionando correctamente</div>
                </div>
              </div>
            </div>

          </div>
        </section>

      </div>
    </main>

  </div>

  <!-- Modal para ver detalles -->
  <div id="detailModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 style="margin:0;">Detalle de Alerta</h3>
        <button class="modal-close" onclick="cerrarModalDetalle()">&times;</button>
      </div>

      <div class="modal-body" id="detailModalBody">
        <!-- Se carga din√°micamente -->
      </div>

      <div class="modal-footer">
        <button class="btn" onclick="cerrarModalDetalle()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal para resolver alerta -->
  <div id="resolveModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 style="margin:0;">Resolver Alerta</h3>
        <button class="modal-close" onclick="cerrarModalResolver()">&times;</button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="resolveAlertId">

        <div class="field">
          <label>
            <input type="checkbox" id="isFalsePositive">
            <span style="margin-left: 8px;">Marcar como falsa alarma</span>
          </label>
        </div>

        <div class="field" style="margin-top: 16px;">
          <label>NOTAS DE RESOLUCI√ìN *</label>
          <textarea
            id="resolutionNotes"
            rows="4"
            placeholder="Describe c√≥mo se resolvi√≥ esta alerta o por qu√© es falsa alarma..."
          ></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" onclick="cerrarModalResolver()">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarResolver()">Resolver</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <strong>‚Äî</strong><span>‚Äî</span>
  </div>

  <script src="app.js"></script>
  <script>
    // Variables globales
    let currentFilters = {
      status: 'pending',
      severity: 'all'
    };

    let allAlerts = [];

    /* =========================
       INICIALIZACI√ìN
       ========================= */
    async function initAlertas() {
      await requireAuth();
      const user = getUser();

      // Solo admin puede ver alertas
      if (user.role !== 'admin') {
        window.location.href = 'egreso.html';
        return;
      }

      hydrateTopbar();
      setupLogout();

      // Cargar datos
      await Promise.all([
        cargarEstadisticas(),
        cargarAlertas()
      ]);

      // Setup filtros
      document.getElementById('btnFilter').addEventListener('click', aplicarFiltros);
      document.getElementById('btnRefresh').addEventListener('click', () => {
        cargarEstadisticas();
        cargarAlertas();
      });

      // Recargar cada 60 segundos
      setInterval(async () => {
        await cargarEstadisticas();
        await cargarAlertas();
      }, 60000);
    }

    /* =========================
       CARGAR ESTAD√çSTICAS
       ========================= */
    async function cargarEstadisticas() {
      try {
        const stats = await api('/api/alerts/stats');

        const html = `
          <div style="background: var(--card2); padding: 16px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: var(--text); margin-bottom: 4px;">${stats.total || 0}</div>
            <div style="font-size: 12px; color: var(--muted); font-weight: 600;">TOTAL</div>
          </div>
          <div style="background: var(--card2); padding: 16px; border-radius: var(--radius); border: 1px solid #f59e0b; text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #f59e0b; margin-bottom: 4px;">${stats.pending || 0}</div>
            <div style="font-size: 12px; color: var(--muted); font-weight: 600;">PENDIENTES</div>
          </div>
          <div style="background: var(--card2); padding: 16px; border-radius: var(--radius); border: 1px solid #ef4444; text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #ef4444; margin-bottom: 4px;">${stats.critical || 0}</div>
            <div style="font-size: 12px; color: var(--muted); font-weight: 600;">CR√çTICAS</div>
          </div>
          <div style="background: var(--card2); padding: 16px; border-radius: var(--radius); border: 1px solid #10b981; text-align: center;">
            <div style="font-size: 28px; font-weight: 800; color: #10b981; margin-bottom: 4px;">${stats.resolved || 0}</div>
            <div style="font-size: 12px; color: var(--muted); font-weight: 600;">RESUELTAS</div>
          </div>
        `;

        document.getElementById('statsGrid').innerHTML = html;

      } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
      }
    }

    /* =========================
       CARGAR ALERTAS
       ========================= */
    async function cargarAlertas() {
      try {
        const params = new URLSearchParams({ limit: 100 });

        if (currentFilters.status !== 'all') {
          params.append('status', currentFilters.status);
        }

        if (currentFilters.severity !== 'all') {
          params.append('severity', currentFilters.severity);
        }

        const data = await api(`/api/alerts?${params}`);
        allAlerts = data.alerts || [];

        renderAlertas(allAlerts);

      } catch (error) {
        console.error('Error cargando alertas:', error);
        toast('Error', 'No se pudieron cargar las alertas', 'error');
        document.getElementById('alertsTbody').innerHTML = '<tr><td colspan="7" class="muted">Error al cargar alertas</td></tr>';
      }
    }

    /* =========================
       RENDERIZAR ALERTAS
       ========================= */
    function renderAlertas(alerts) {
      const tbody = document.getElementById('alertsTbody');
      const emptyState = document.getElementById('emptyState');
      const table = document.getElementById('alertsTable');
      const countEl = document.getElementById('alertCount');

      if (!alerts || alerts.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        countEl.textContent = 'No hay alertas que mostrar';
        return;
      }

      table.style.display = 'table';
      emptyState.style.display = 'none';
      countEl.textContent = `${alerts.length} alerta(s) encontrada(s)`;

      const html = alerts.map(alert => {
        // Badge de severidad
        let severityBadge = '';
        let severityColor = '';
        switch(alert.severity) {
          case 'critical':
            severityColor = '#ef4444';
            severityBadge = '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">CR√çTICA</span>';
            break;
          case 'high':
            severityColor = '#f97316';
            severityBadge = '<span style="background: #f97316; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">ALTA</span>';
            break;
          case 'medium':
            severityColor = '#f59e0b';
            severityBadge = '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">MEDIA</span>';
            break;
          default:
            severityColor = '#3b82f6';
            severityBadge = '<span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">BAJA</span>';
        }

        // Badge de estado
        let statusBadge = '';
        switch(alert.status) {
          case 'pending':
            statusBadge = '<span style="background: rgba(249, 115, 22, 0.15); color: #f97316; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">PENDIENTE</span>';
            break;
          case 'acknowledged':
            statusBadge = '<span style="background: rgba(59, 130, 246, 0.15); color: #3b82f6; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">VISTA</span>';
            break;
          case 'resolved':
            statusBadge = '<span style="background: rgba(16, 185, 129, 0.15); color: #10b981; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">RESUELTA</span>';
            break;
          default:
            statusBadge = '<span style="background: rgba(100, 116, 139, 0.15); color: #64748b; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">FALSA ALARMA</span>';
        }

        // Tipo de alerta
        let tipoTexto = alert.alert_type.replace(/_/g, ' ').toUpperCase();

        // Fecha
        const fecha = new Date(alert.created_at).toLocaleString('es-AR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Acciones
        let acciones = `<button class="btn-table" onclick="verDetalle(${alert.id})" title="Ver detalle">üëÅÔ∏è</button>`;

        if (alert.status === 'pending') {
          acciones += `<button class="btn-table" onclick="acknowledgeAlert(${alert.id})" title="Marcar como vista">‚úì</button>`;
          acciones += `<button class="btn-table" onclick="mostrarModalResolver(${alert.id})" title="Resolver">‚úÖ</button>`;
        } else if (alert.status === 'acknowledged') {
          acciones += `<button class="btn-table" onclick="mostrarModalResolver(${alert.id})" title="Resolver">‚úÖ</button>`;
        }

        return `
          <tr style="border-left: 3px solid ${severityColor};">
            <td>${severityBadge}</td>
            <td><span style="font-size: 11px; color: var(--muted);">${escapeHtml(tipoTexto)}</span></td>
            <td><strong>${escapeHtml(alert.message)}</strong></td>
            <td>${escapeHtml(alert.username || '‚Äî')}</td>
            <td><span class="muted">${fecha}</span></td>
            <td>${statusBadge}</td>
            <td>${acciones}</td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = html;
    }

    /* =========================
       FILTROS
       ========================= */
    function aplicarFiltros() {
      currentFilters.status = document.getElementById('filterStatus').value;
      currentFilters.severity = document.getElementById('filterSeverity').value;
      cargarAlertas();
    }

    /* =========================
       VER DETALLE
       ========================= */
    function verDetalle(alertId) {
      const alert = allAlerts.find(a => a.id === alertId);
      if (!alert) return;

      const metadata = alert.metadata || {};
      const metadataHtml = Object.keys(metadata).length > 0
        ? Object.entries(metadata).map(([key, value]) => {
            let displayValue = value;
            if (key === 'monto' && typeof value === 'number') {
              displayValue = '$' + value.toLocaleString('es-AR');
            } else if (typeof value === 'object') {
              displayValue = JSON.stringify(value, null, 2);
            }
            return `
              <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px; padding: 8px; background: var(--card2); border-radius: 4px;">
                <strong style="color: var(--muted);">${escapeHtml(key)}:</strong>
                <span style="color: var(--text); word-break: break-word;">${escapeHtml(String(displayValue))}</span>
              </div>
            `;
          }).join('')
        : '<div class="muted">No hay metadata disponible</div>';

      const html = `
        <div style="display: grid; gap: 16px;">
          <div>
            <strong style="color: var(--muted); font-size: 12px;">T√çTULO</strong>
            <div style="font-size: 16px; font-weight: 700; color: var(--text); margin-top: 4px;">${escapeHtml(alert.title)}</div>
          </div>

          <div>
            <strong style="color: var(--muted); font-size: 12px;">MENSAJE</strong>
            <div style="color: var(--text); margin-top: 4px;">${escapeHtml(alert.message)}</div>
          </div>

          <div>
            <strong style="color: var(--muted); font-size: 12px;">METADATA</strong>
            <div style="margin-top: 8px; display: grid; gap: 8px;">${metadataHtml}</div>
          </div>

          ${alert.resolution_notes ? `
            <div>
              <strong style="color: var(--muted); font-size: 12px;">NOTAS DE RESOLUCI√ìN</strong>
              <div style="color: var(--text); margin-top: 4px; padding: 12px; background: var(--card2); border-radius: 4px; border-left: 3px solid #10b981;">
                ${escapeHtml(alert.resolution_notes)}
              </div>
            </div>
          ` : ''}
        </div>
      `;

      document.getElementById('detailModalBody').innerHTML = html;
      document.getElementById('detailModal').style.display = 'flex';
    }

    function cerrarModalDetalle() {
      document.getElementById('detailModal').style.display = 'none';
    }

    /* =========================
       ACCIONES DE ALERTAS
       ========================= */
    async function acknowledgeAlert(alertId) {
      try {
        await api(`/api/alerts/${alertId}/acknowledge`, { method: 'POST' });
        toast('‚úì Marcada', 'Alerta marcada como vista', 'success');
        await cargarAlertas();
        await cargarEstadisticas();
      } catch (error) {
        console.error('Error:', error);
        toast('Error', error.message || 'No se pudo marcar la alerta', 'error');
      }
    }

    function mostrarModalResolver(alertId) {
      document.getElementById('resolveAlertId').value = alertId;
      document.getElementById('isFalsePositive').checked = false;
      document.getElementById('resolutionNotes').value = '';
      document.getElementById('resolveModal').style.display = 'flex';
    }

    function cerrarModalResolver() {
      document.getElementById('resolveModal').style.display = 'none';
    }

    async function confirmarResolver() {
      const alertId = document.getElementById('resolveAlertId').value;
      const isFalsePositive = document.getElementById('isFalsePositive').checked;
      const notes = document.getElementById('resolutionNotes').value.trim();

      if (!notes) {
        toast('Validaci√≥n', 'Por favor ingresa notas de resoluci√≥n', 'warning');
        return;
      }

      try {
        await api(`/api/alerts/${alertId}/resolve`, {
          method: 'POST',
          body: {
            notes,
            is_false_positive: isFalsePositive
          }
        });

        toast('‚úÖ Resuelta', 'Alerta resuelta correctamente', 'success');
        cerrarModalResolver();
        await cargarAlertas();
        await cargarEstadisticas();

      } catch (error) {
        console.error('Error:', error);
        toast('Error', error.message || 'No se pudo resolver la alerta', 'error');
      }
    }

    /* =========================
       INICIO
       ========================= */
    document.addEventListener('DOMContentLoaded', initAlertas);
  </script>
</body>
</html>
